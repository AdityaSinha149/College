Router is involved in the **forwarding function** of the network layer. It has 4 components -
- **Input ports** : It performs several functions - ^b9d301
	1. Physical layer function of terminating the incoming link at the router. This is done by the leftmost box of the input port
	2. Link layer function needed to interoperate with the link layer at the other side of the incoming link. This is represented by the middle boxes in the input and output ports.
	3. The most crucial, the lookup function is performed in the rightmost box. It is here where the forwarding table is consulted to determine the output port to which the packet would be delivered.
- **Switching fabric** : The switching fabric connects the routerâ€™s input ports to its output ports. This switching fabric is completely contained within the router - a network inside of a network, router!
- **Output ports** : It stores the packet received from the switching fabric and transmits it on the outgoing link by performing necessary link and physical layer functions. When the link is bidirectional, an output port is paired with the input port for that link on the same line card.
- **Routing processor** : It executes routing protocols, maintains routing tables and attached state information, and computes forwarding table for the router.
  ![[4.6.png]]

### 4.3.1 Input Processing
The input port's line termination and link layer processing implements the physical and link layers for that input link. The lookup performed is central to the whole router.  The forwarding table is computed and updated by the routing processor, with a shadow copy stored at each input port. It is copied from the routing processor to the line cards over a different bus. *With this shadow copy, the forwarding decision could be taken locally without involving the centralized routing processor hence avoiding centralized processing bottleneck.*

Because of high transmission rates, not only the lookup has to be performed in hardware but also techniques beyond a simple linear search has to be used.

Once the packet's output port has been determined it is sent to the switching fabric. If packets from other input ports are using the switching fabric, the packet is blocked. It is [queued](#^queueing) at the input port and scheduled to cross the fabric at later point of time.

Other actions taken by input port are -
- packet's version, checksum and ttl field should  be checked and updated.[Detailed in 4.4.1](4.4%20The%20Internet%20Protocol.md#^format)
- counters used in network management must be updated.
![[4.7.png]]
### 4.3.2 Switching
It is the very heart of the router as it is through this fabric that the packets are actually forwarded from an input port to an output port.

Switching Techniques -
- **Switching via memory** : The earliest routers used this technique. IN this technique the switching between input and output ports is done under direct control of the CPU. The CPU is the routing processor. The input port with an arriving packet signals the routing processor via an interrupt, then the routing processor extracts the destination address, looks the appropriate output port from the forwarding table and copy the packet to the output port's buffer.
  In this if the memory bandwidth is such that B packets per second can be read from or written into memory then the overall forwarding throughput(Rate at which packets transfer from input ports to output ports) should be less than B/2.
  Also as we could only do one memory read/write over the shared bus, even if there are 2 packets with different output ports, they still cannot be forwarded at the same time.
  Many modern routers use memory-based switching. Unlike early routers, they perform destination lookup and store packets on the input line cards, similar to shared-memory multiprocessors.
  ![[4.8.1.png]]
- **Switching via a bus** : In this approach an input bus directly transfers the packet to the output port without any intervention of the routing processor. The input port pre-pends a header to the packet indicating the output port, the packet is transferred to all the ports and all but one port discards it. The label is then removed at the output port as it is used only to cross the bus.
  If multiple packets arrive at the router at the same time, each at a different input port, all but one packet have to wait as only one packet can cross the bus at a time. Because of this the router's speed is limited by the bus's speed.
  ![[4.8.2.png]]
- **Switching via an interconnection network** : To overcome the limitation of bandwidth we use an interconnection network like crossbar. It has 2N busses that connects N input ports to N output ports. Each vertical bus intersects each horizontal bus at a crosspoint, which can be opened and closed by the switching fabric controller at any point of time.
  If there is a packet at port A and has to go to port B the switching fabric controller closes the crosspoint between A an Y, port A sends the packet to the bus and port y takes it.
  ![[4.8.3.png]]
### 4.3.3 Output Processing
Output port processing takes the packets stored in output port's memory and transmits it to the output link. It involves selecting and dequeueing packets for transmission and performing the needed link layer and physical layer functions.
![[4.9.png]]
### 4.3.4 Where Does Queueing Occur? ^queueing
Queueing can occur both at the input ports or the output ports. Queue grows large it exhausts the router's memory and this is when a packet is dropped by the router.It depends on the traffic and the relative speed of switching fabric and line speed. 
#### Output Port Queueing
When arrival rate exceeds the output link speed, the packets start queuing at the output port.
When packets start to queue at the output port, as a consequence a packet scheduler at output port has to choose the next packet that would be transmitted. Packet scheduling ensures quality of service.
![[4.10.png]]
#### Input Port Queueing
When arrival rate exceeds the output link speed, the packets start queuing at the input port.
If there are multiple packets from one input port and a packet is blocked for some reason, any packet after it would also be blocked. This is called Head of Line(HOL) blocking.
![[4.11.png]]
### 4.3.5 The Routing Control Plane